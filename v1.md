# Auth Service Architecture Specification

## Overview

Standalone authentication microservice responsible for identity, token
issuance, session management, and credential validation. Designed as an
internal authentication authority similar in role to Auth0 but
self‑hosted and fully controllable.

------------------------------------------------------------------------

## Repository Structure

    auth-service/
    ├── app/
    │   ├── main.py
    │   ├── config.py
    │   ├── dependencies.py
    │   ├── middleware/
    │   ├── routers/
    │   ├── core/
    │   ├── models/
    │   ├── schemas/
    │   ├── db/
    │   └── services/
    ├── sdk/
    ├── migrations/
    ├── tests/
    ├── docker/
    ├── k8s/
    └── pyproject.toml

------------------------------------------------------------------------

## Core Stack

-   Python 3.11
-   FastAPI
-   SQLAlchemy Async
-   Postgres
-   Redis
-   Authlib
-   python-jose
-   python3-saml
-   OpenTelemetry
-   Prometheus
-   Structlog

------------------------------------------------------------------------

## Configuration Layer

Uses strongly typed environment configuration via pydantic-settings.

Features: - No hardcoded secrets - Type validation - Centralized
config - Cached settings instance

------------------------------------------------------------------------

## Database Schema

Tables:

### users

Canonical identity record.

### user_identities

Links external auth providers to users.

### sessions

Server-side session ledger.

### api_keys

Stores hashed API keys.

All tables include: - created_at - updated_at - deleted_at - tenant_id

------------------------------------------------------------------------

## Authentication Design

### JWT Access Tokens

-   Algorithm: RS256
-   Short lifetime
-   Stateless verification
-   Public key distribution via JWKS endpoint

### Refresh Tokens

-   Stored in Redis
-   Linked to DB session record
-   Rotated on use
-   Sliding expiration window

### Logout

-   Deletes Redis session
-   Marks DB session revoked

### Immediate Revocation

Redis blocklist of JWT IDs.

------------------------------------------------------------------------

## OAuth Flow

Authorization Code with PKCE.

Steps: 1. Redirect user to provider 2. Provider returns code 3. Exchange
code for tokens 4. Fetch user profile 5. Upsert identity

------------------------------------------------------------------------

## SAML Flow

Steps: 1. Generate AuthnRequest 2. Redirect to IdP 3. Receive
SAMLResponse 4. Validate assertion 5. Upsert identity

Metadata endpoint provided for IdP configuration.

------------------------------------------------------------------------

## API Key System

Format:

    sk_<random>

Storage: - Only SHA256 hash stored - Prefix stored for UI display - Raw
key shown once

Verification uses constant time comparison.

------------------------------------------------------------------------

## Middleware Stack Order

1.  Correlation ID
2.  Structured logging
3.  Rate limiting
4.  Tracing
5.  Metrics

------------------------------------------------------------------------

## Security Requirements

-   Secure cookies
-   CSP headers
-   Redirect allowlist
-   Constant time comparisons
-   Key rotation
-   Secret manager usage
-   Row-level encryption

------------------------------------------------------------------------

## SDK Responsibilities

### Middleware

-   JWT verification
-   API key verification

### Client

Async HTTP wrapper for auth service endpoints.

### Injection

Adds authenticated user object to request state.

------------------------------------------------------------------------

## Infrastructure

### Docker

-   Multi-stage build
-   Slim runtime image
-   Non-root execution

### Kubernetes

-   3 replicas minimum
-   Rolling deployments
-   Health probes
-   HPA scaling
-   Pod disruption budget
-   Network policy
-   External secret sync

------------------------------------------------------------------------

## Testing Strategy

### Unit Tests

Isolated module validation.

### Integration Tests

Full stack tests with real DB and Redis.

### Contract Tests

Protocol correctness.

### Load Tests

Stress login and refresh endpoints.

------------------------------------------------------------------------

## Recommended Build Order

1.  Configuration and DB
2.  Users + JWT auth
3.  Sessions
4.  OAuth
5.  API keys
6.  SAML
7.  Middleware
8.  SDK
9.  Deployment infra
10. Load testing and review

------------------------------------------------------------------------

## Design Principles

-   Stateless where possible
-   Stateful only where necessary
-   Provider‑agnostic identity model
-   Security first
-   Horizontal scalability
-   Observability built in
