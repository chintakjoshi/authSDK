name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        type: choice
        options:
          - staging
          - production
      namespace:
        description: "Kubernetes namespace"
        required: true
        default: auth-service
        type: string

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Kubernetes manifests
        id: manifests
        shell: bash
        run: |
          COUNT=$(find k8s -maxdepth 1 -type f -name '*.yaml' -size +0c | wc -l | tr -d ' ')
          if [ "$COUNT" -gt 0 ]; then
            echo "ready=true" >> "$GITHUB_OUTPUT"
          else
            echo "::warning::No populated Kubernetes manifests found in k8s/. Skipping deploy."
            echo "ready=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up kubectl
        if: steps.manifests.outputs.ready == 'true'
        uses: azure/setup-kubectl@v4
        with:
          version: latest

      - name: Configure kubeconfig
        if: steps.manifests.outputs.ready == 'true'
        env:
          KUBE_CONFIG_B64: ${{ secrets.KUBE_CONFIG_B64 }}
        shell: bash
        run: |
          if [ -z "$KUBE_CONFIG_B64" ]; then
            echo "::error::Missing required repository/environment secret: KUBE_CONFIG_B64"
            exit 1
          fi
          echo "$KUBE_CONFIG_B64" | base64 --decode > kubeconfig
          echo "KUBECONFIG=$PWD/kubeconfig" >> "$GITHUB_ENV"

      - name: Create namespace if needed
        if: steps.manifests.outputs.ready == 'true'
        shell: bash
        run: |
          kubectl create namespace "${{ inputs.namespace }}" --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply manifests
        if: steps.manifests.outputs.ready == 'true'
        shell: bash
        run: |
          kubectl apply -n "${{ inputs.namespace }}" -f k8s/
